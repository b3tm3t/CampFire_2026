<!DOCTYPE html>
<html>
<head>
    <title>Worm Game 3</title>
    <style>
        body {font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #eef2f3; margin: 0; overflow: hidden;}
        .card {background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); text-align: center; position: absolute; z-index: 10;}
        button {padding: 10px 20px; cursor: pointer; background: #2ecc71; color: white; border: none; border-radius: 5px; font-size: 1.1rem;}
        button:hover {background: #27ae60}
        canvas { 
            background: #222; 
            display: none; 
            position: absolute; 
            top: 0; 
            left: 0;
        }
    </style>
</head>
<body>
    
    <div class="card">
        <h1 id="message">Wormy the Wormypus</h1>
        <button id="startBtn">Start Game</button>
    </div>
    <div id="winCard" class="card" style="display: none;">
        <h1>You Win!</h1>
        <p>The garden is clean!</p>
        <button onclick="location.reload()">Play Again</button>
    </div>
    <canvas id="gameCanvas"></canvas>
    
    <script type="module">
        import { Player } from './Player.js';
        import { Map } from './Map.js';
        import { Rock } from './Rock.js';
        
        const myButton = document.getElementById('startBtn');
        const mainCanvas = document.getElementById('gameCanvas');
        const ctx = mainCanvas.getContext('2d');
        const keys = {};
        
        // --- 1. WORLD SETTINGS ---
        const worldWidth = 3200;
        const worldHeight = 1800;
        
        let ticks = 0;
        
        // --- 2. LOAD ASSETS ---
        const backgroundImage = new Image();
        backgroundImage.src = "./BackdropWormGame.png";
        
        // --- 3. CREATE OBJECTS ---
        const map = new Map(worldWidth, worldHeight); 
        const rocks = [];
        
        // Create 20 random rocks
        for(let i = 0; i < 20; i++) {
            // Random Position
            let rx = Math.random() * worldWidth;
            let ry = Math.random() * (worldHeight - 310) + 310;
            
            // Random Size (Radius between 30 and 80)
            let rSize = Math.random() * 50 + 30;
            
            // Create the rock
            rocks.push(new Rock(rx, ry, rSize));
        }
        // --- FIX: Start Length is now 1 ---
        const worm = new Player(700, 400, 4, 30, 100, 1, map);
        map.setPlayer(worm); 
        
        // Input Handling
        window.addEventListener('keydown', (e) => keys[e.key] = true);
        window.addEventListener('keyup', (e) => keys[e.key] = false);
        
        // --- AUDIO SYSTEM ---
        const playlist = [
        './audio/Worm on a roll.mp3',
        './audio/Bloopin.mp3'
        ];
        
        let currentTrack = 0;
        const audioPlayer = new Audio(playlist[currentTrack]);
        audioPlayer.volume = 0.4; 
        
        function playNextTrack() {
            currentTrack = (currentTrack + 1) % playlist.length;
            audioPlayer.src = playlist[currentTrack];
            audioPlayer.play().catch(e => console.log("Audio play blocked until interaction"));
        }
        audioPlayer.addEventListener('ended', playNextTrack);
        
        
        function gameLoop() {
            // A. UPDATE PHYSICS
            worm.calculateAngle(keys);
            
            let dirtDug = 0;
            // Calculate dirt removed
            for (let i = 0; i < worm.wormNodes.length; i++) {
                dirtDug += map.dig(worm.wormNodes[i].pos_x, worm.wormNodes[i].pos_y, worm.wormNodes[i].width);
            }
            
            // Pass dirtDug to velocity
            worm.calculateVelocity(keys, dirtDug);
            
            // --- CRITICAL FIX: Pass 'rocks' as the 3rd argument ---
            // (If you pass dirtDug here by mistake, collision won't work)
            worm.updatePos(worldWidth, worldHeight, rocks); 
            
            // Check for death
            if (worm.health <= 0) {
                alert("Game Over! You hit too many rocks.");
                location.reload();
                return;
            }
            
            // ... rest of loop (growth logic, camera, drawing) ...
            // B. DIGGING LOGIC
            // Dig at every node position
            
            
            
            // --- FIX: PERCENTAGE BASED GROWTH ---
            // Calculate current percentage
            let percent = (map.dirtRemoved / map.totalDirtPixels) * 100;
            
            // Formula: Start at 1. Add 1 segment for every 0.5% cleared.
            // Example: 0.5% = Length 2. 1.0% = Length 3.
            let targetLength = 1 + Math.floor(percent / 0.5);
            
            // If we are shorter than the target, GROW
            while (worm.wormNodes.length < targetLength) {
                worm.grow();
                console.log(`Growing! Pct: ${percent.toFixed(2)}% | New Length: ${worm.wormNodes.length}`);
            }
            
            // C. CAMERA LOGIC
            let camX = worm.map_x - (mainCanvas.width / 2 / map.cameraScale);
            let camY = worm.map_y - (mainCanvas.height / 2 / map.cameraScale);
            
            camX = Math.max(0, Math.min(camX, worldWidth - (mainCanvas.width / map.cameraScale)));
            camY = Math.max(0, Math.min(camY, worldHeight - (mainCanvas.height / map.cameraScale)));
            
            // D. DRAWING
            ctx.clearRect(0, 0, mainCanvas.width, mainCanvas.height);
            
            ctx.save(); // <--- START CAMERA
            
            ctx.scale(map.cameraScale, map.cameraScale);
            ctx.translate(-camX, -camY);
            
            // Draw Background
            if (backgroundImage.complete && backgroundImage.naturalWidth !== 0) {
                ctx.drawImage(backgroundImage, 0, 0, worldWidth, worldHeight);
            } else {
                ctx.fillStyle = "#333";
                ctx.fillRect(0,0, worldWidth, worldHeight);
            }
            
            // RAIN LOGICa
            if (Math.random() < 0.0002) { 
                map.startRain();
            }
            
            if (map.isRaining) {
                map.rainLevel += 5; 
                if (map.rainLevel > worldHeight) {
                    map.isRaining = false;
                }
            }
            
            map.draw(ctx, worldWidth);
            worm.draw(ctx);
            
            for (let r of rocks) {
                r.draw(ctx);
            }
            
            ctx.restore(); // <--- END CAMERA
            
            // E. HUD
            ctx.fillStyle = "rgba(0,0,0,0.5)";
            ctx.fillRect(0, 0, mainCanvas.width, 80); 
            
            let percentString = percent.toFixed(2);
            let currentDepth = Math.max(0, Math.floor(map.lowestDugY - 310));
            
            ctx.fillStyle = "white";
            ctx.font = "20px sans-serif";
            
            // Line 1
            ctx.fillText(`Pos: ${Math.floor(worm.map_x)}, ${Math.floor(worm.map_y-310)} | Dirt Cleared: ${percentString}%`, 20, 35);
            
            // Line 2
            ctx.fillStyle = "#ffff00"; 
            ctx.fillText(`Deepest: ${currentDepth}px  |  Length: ${worm.wormNodes.length}`, 20, 65);
            
            if (percent > 99.9) {
                document.getElementById('winCard').style.display = 'block';
                return; 
            }
            
            // Dynamic Camera Zoom (Limit zoom out so we don't see edges too much)
            map.cameraScale = Math.max(3 - worm.wormNodes.length/80, 1.0);
            
            requestAnimationFrame(gameLoop);
            ticks++;
        }
        
        myButton.addEventListener('click', () => {
            document.querySelector('.card').style.display = 'none';
            mainCanvas.width = window.innerWidth;
            mainCanvas.height = window.innerHeight;
            mainCanvas.style.display = 'block';
            
            audioPlayer.play();
            gameLoop();
        });
        
        window.addEventListener('resize', () => {
            if (mainCanvas.style.display === 'block') {
                mainCanvas.width = window.innerWidth;
                mainCanvas.height = window.innerHeight;
            }
        });
    </script>
</body>
</html>