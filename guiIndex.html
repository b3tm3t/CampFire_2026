<!DOCTYPE html>
<html>
<head>
    <title>Worm Game Final</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: #eef2f3;
            margin: 0;
            overflow: hidden;
        }
        .card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            position: absolute;
            z-index: 10;
            max-width: 600px;
            width: 90%;
        }
        h1, h2, h3 { margin-top: 0; }
        p { line-height: 1.6; color: #555; }
        
        button {
            padding: 15px 30px;
            cursor: pointer;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: bold;
            transition: transform 0.2s, background 0.2s;
        }
        button:hover {
            background: #27ae60;
            transform: scale(1.05);
        }
        
        .info-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-around;
        }
        
        canvas { 
            background: #222; 
            display: none; 
            position: absolute; 
            top: 0; 
            left: 0;
        }
    </style>
</head>
<body>
    
    <div id="startCard" class="card">
        <h1>Wormy the Wormypus</h1>
        <p>The garden needs you.</p>
        <button id="startBtn">Start Mission</button>
    </div>
    
    <div id="instructionCard" class="card" style="display: none;">
        <h2 style="color: #2ecc71;">Mission Briefing</h2>
        
        <div style="text-align: left; margin: 20px 0; font-size: 1rem;">
            <p><strong>The Story:</strong> The world's soil is toxic because humans are... well, pooping too much. The ecosystem is collapsing.</p>
            <p><strong>Your Job:</strong> You are the last hope. You must eat the toxic dirt to expose the fresh, revitalized soil underneath. Do it quickly before the toxicity spreads!</p>
        </div>
        
        <div class="info-box">
            <div>
                <strong>Controls</strong><br>
                WASD or Arrow Keys
            </div>
            <div>
                <strong>Objective</strong><br>
                Clear dirt in 2 Minutes!
            </div>
        </div>
        
        <h3 id="countdown" style="font-size: 2.5rem; color: #e74c3c; margin-bottom: 0;">Starting in 15...</h3>
    </div>
    
    <div id="endCard" class="card" style="display: none;">
        <h1 id="endTitle">Game Over</h1>
        <p id="endMessage">...</p>
        <button onclick="location.reload()">Play Again</button>
    </div>
    
    <canvas id="gameCanvas"></canvas>
    
    <script type="module">
        import { Player } from './Player.js';
        import { Map } from './Map.js';
        import { Rock } from './Rock.js';
        
        // --- DOM ELEMENTS ---
        const startCard = document.getElementById('startCard');
        const instructionCard = document.getElementById('instructionCard');
        const countdownText = document.getElementById('countdown');
        const endCard = document.getElementById('endCard');
        const startBtn = document.getElementById('startBtn');
        const mainCanvas = document.getElementById('gameCanvas');
        const ctx = mainCanvas.getContext('2d');
        
        // --- INPUTS ---
        const keys = {};
        window.addEventListener('keydown', (e) => keys[e.key] = true);
        window.addEventListener('keyup', (e) => keys[e.key] = false);
        
        // --- WORLD SETTINGS ---
        const worldWidth = 3200;
        const worldHeight = 1800;
        let ticks = 0;
        let gameTime = 180; // 3 minutes (in seconds)
        let isGameRunning = false;

        // --- ASSETS ---
        const backgroundImage = new Image();
        backgroundImage.src = "./BackdropWormGame.png";
        
        // --- AUDIO SYSTEM ---
        const playlist = ['./audio/Worm on a roll.mp3', './audio/Egypt.mp3'];
        let currentTrack = 0;
        const audioPlayer = new Audio(playlist[currentTrack]);
        audioPlayer.volume = 1.0; 
        
        function playNextTrack() {
            currentTrack = (currentTrack + 1) % playlist.length;
            audioPlayer.src = playlist[currentTrack];
            audioPlayer.play().catch(e => console.log("Audio waiting for interaction"));
        }
        audioPlayer.addEventListener('ended', playNextTrack);

        // --- CREATE OBJECTS ---
        const map = new Map(worldWidth, worldHeight);
        const rocks = [];
        
        // Create 20 random rocks
        for(let i = 0; i < 20; i++) {
            let rx = Math.random() * worldWidth;
            let ry = Math.random() * (worldHeight - 310) + 310;
            let rSize = Math.random() * 50 + 30;
            rocks.push(new Rock(rx, ry, rSize));
        }

        // Create Worm (Start length 1)
        const worm = new Player(700, 400, 4, 30, 100, 1, map);
        map.setPlayer(worm); 
        
        // --- MAIN GAME LOOP ---
        function gameLoop() {
            if (!isGameRunning) return;
            
            // 1. UPDATE TIMER
            let secondsPassed = Math.floor(ticks / 60);
            let timeLeft = gameTime - secondsPassed;

            // 2. UPDATE PHYSICS
            worm.calculateAngle(keys);
            
            let dirtDug = 0;
            // Dig at every node to ensure smooth tunnels
            for (let i = 0; i < worm.wormNodes.length; i++) {
                dirtDug += map.dig(worm.wormNodes[i].pos_x, worm.wormNodes[i].pos_y, worm.wormNodes[i].width);
            }
            
            // Note: If movement is stuck, check Player.js friction divisor (should be 1000, not 150)
            worm.calculateVelocity(keys, dirtDug);
            worm.updatePos(worldWidth, worldHeight, rocks); 
            
            // 3. CHECK WIN/LOSS CONDITIONS
            
            // Condition A: Health
            if (worm.health <= 0) {
                endGame("Mission Failed", "Your worm took too much damage from rocks!");
                return;
            }
            
            // Condition B: Time
            if (timeLeft <= 0) {
                endGame("Time's Up!", "The soil toxicity levels remain too high.");
                return;
            }

            // Condition C: Regen Health Randomly
            if (Math.random() < 0.01) {
                worm.health = Math.min(100, worm.health + 0.1);
            }
            
            // Condition D: Victory (75% Cleared)
            let percent = (map.dirtRemoved / map.totalDirtPixels) * 100;
            if (percent > 75) {
                endGame("Victory!", "The garden is clean and the soil is fresh!");
                return;
            }
            
            // 4. GROWTH LOGIC
            // Formula: Start at 1. Add 1 segment for every 0.5% cleared.
            let targetLength = 1 + Math.floor(percent / 0.5);
            while (worm.wormNodes.length < targetLength) {
                worm.grow();
            }
            
            // 5. CAMERA
            let camX = worm.map_x - (mainCanvas.width / 2 / map.cameraScale);
            let camY = worm.map_y - (mainCanvas.height / 2 / map.cameraScale);
            
            camX = Math.max(0, Math.min(camX, worldWidth - (mainCanvas.width / map.cameraScale)));
            camY = Math.max(0, Math.min(camY, worldHeight - (mainCanvas.height / map.cameraScale)));
            
            // Dynamic Zoom
            map.cameraScale = Math.max(3 - worm.wormNodes.length/80, 1.0);
            
            // 6. DRAWING
            ctx.clearRect(0, 0, mainCanvas.width, mainCanvas.height);
            
            ctx.save(); 
            ctx.scale(map.cameraScale, map.cameraScale);
            ctx.translate(-camX, -camY);
            
            // Background
            if (backgroundImage.complete && backgroundImage.naturalWidth !== 0) {
                ctx.drawImage(backgroundImage, 0, 0, worldWidth, worldHeight);
            } else {
                ctx.fillStyle = "#333";
                ctx.fillRect(0,0, worldWidth, worldHeight);
            }
            
            // Rain Logic
            if (Math.random() < 0.0002) map.startRain();
            if (map.isRaining) {
                map.rainTime = (map.rainTime || 0) + 1;
                if (map.rainTime < 60 * 20) map.rainLevel += 1;
                else if (map.rainTime < 60 * 50) map.rainLevel -= 1;
                else { map.isRaining = false; map.rainTime = 0; }
            }
            
            map.draw(ctx, worldWidth); // Passed worldWidth to fix drawing
            worm.draw(ctx);
            
            // Rocks 
            for (let r of rocks) {
                r.draw(ctx);
            }
            
            ctx.restore(); 
            
            // 7. HUD (Head Up Display)
            drawHUD(percent, timeLeft, worm.health);
            
            requestAnimationFrame(gameLoop);
            ticks++;
        }
        
        function drawHUD(percent, timeLeft, health) {
            ctx.fillStyle = "rgba(0,0,0,0.6)";
            ctx.fillRect(0, 0, mainCanvas.width, 80); 
            
            ctx.fillStyle = "white";
            ctx.font = "bold 20px sans-serif";
            
            let percentString = percent.toFixed(2);
            let currentDepth = Math.max(0, Math.floor(map.lowestDugY - 310));
            
            // Line 1
            ctx.fillText(`Dirt Cleared: ${percentString}%`, 20, 35);
            
            // Line 2 (Timer color changes if low)
            ctx.fillStyle = timeLeft < 30 ? "#ff4444" : "#ffff00"; 
            ctx.fillText(`Time Left: ${timeLeft}s`, 20, 65);
            
            // Line 3 (Stats)
            ctx.fillStyle = "#ddd";
            ctx.fillText(`Deepest: ${currentDepth}px  |  Length: ${worm.wormNodes.length}`, 250, 65);
        }
        
        function endGame(title, message) {
            isGameRunning = false;
            mainCanvas.style.display = 'none';
            endCard.style.display = 'block';
            document.getElementById('endTitle').innerText = title;
            document.getElementById('endMessage').innerText = message;
        }
        
        // --- BUTTON LOGIC ---
        startBtn.addEventListener('click', () => {
            // 1. Hide Start Menu
            startCard.style.display = 'none';
            
            // 2. Show Instructions
            instructionCard.style.display = 'block';
            
            let secondsLeft = 10;
            
            // 3. Countdown Timer
            const timerInterval = setInterval(() => {
                secondsLeft--;
                countdownText.innerText = `Starting in ${secondsLeft}...`;
                
                if (secondsLeft <= 0) {
                    clearInterval(timerInterval);
                    
                    // 4. Start Game
                    instructionCard.style.display = 'none';
                    mainCanvas.style.display = 'block';
                    mainCanvas.width = window.innerWidth;
                    mainCanvas.height = window.innerHeight;
                    
                    isGameRunning = true;
                    audioPlayer.play().catch(e => console.log("Audio needs user interaction"));
                    gameLoop();
                }
            }, 1000);
        });
        
        window.addEventListener('resize', () => {
            if (mainCanvas.style.display === 'block') {
                mainCanvas.width = window.innerWidth;
                mainCanvas.height = window.innerHeight;
            }
        });
        
    </script>
</body>
</html>